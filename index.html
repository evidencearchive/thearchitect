<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Archive | Decoding Death Investigation</title>
    <link rel="stylesheet" href="evidence-styles.css">
    <!-- Load API proxy script with a more robust approach -->
    <script>
        // Dynamically load the API proxy script
        (function() {
            function loadApiProxy() {
                // Try different possible paths to find the API proxy
                const possiblePaths = [
                    '../decoding-death-website/api-proxy.js',
                    '../../decoding-death-website/api-proxy.js',
                    '/decoding-death-website/api-proxy.js'
                ];
                
                function tryLoadScript(paths, index) {
                    if (index >= paths.length) {
                        console.error('Failed to load API Proxy script from any path');
                        showApiError();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = paths[index];
                    script.onload = function() {
                        console.log('API Proxy loaded successfully from: ' + paths[index]);
                    };
                    script.onerror = function() {
                        console.warn('Failed to load API Proxy from: ' + paths[index]);
                        tryLoadScript(paths, index + 1);
                    };
                    document.head.appendChild(script);
                }
                
                tryLoadScript(possiblePaths, 0);
            }
            
            function showApiError() {
                // Show error message when page loads if API proxy fails to load
                window.addEventListener('DOMContentLoaded', function() {
                    const errorContainer = document.getElementById('error-container');
                    if (errorContainer) {
                        errorContainer.classList.remove('hidden');
                        errorContainer.innerHTML = `
                            <div class="error-message">
                                <p>Failed to load API services. Please try accessing this page through the main game experience.</p>
                                <button id="retry-button">Retry</button>
                            </div>
                        `;
                        
                        document.getElementById('retry-button').addEventListener('click', function() {
                            window.location.reload();
                        });
                    }
                });
            }
            
            loadApiProxy();
        })();
    </script>
</head>
<body>
    <div class="page-container">
        <!-- Error container for API loading issues -->
        <div id="error-container" class="hidden"></div>
        
        <header class="evidence-header">
            <div class="header-content">
                <h1>Evidence Archive</h1>
                <p class="subtitle">CASE #DD-2025-0317 | CONFIDENTIAL</p>
                <div class="case-details">
                    <div class="case-number">INVESTIGATIVE TASK FORCE</div>
                    <div class="classification">RESTRICTED ACCESS</div>
                </div>
            </div>
        </header>

        <main class="evidence-container">
            <div id="loading-indicator" class="loading-overlay">
                <div class="loading-spinner"></div>
                <p>Accessing evidence archives...</p>
            </div>

            <div id="evidence-grid" class="evidence-grid">
                <!-- Evidence items will be dynamically inserted here -->
            </div>
        </main>

        <footer class="evidence-footer">
            <p>Decoding Death Investigation</p>
            <p class="footer-note">OFFICIAL INVESTIGATIVE DOCUMENT - UNAUTHORIZED ACCESS PROHIBITED</p>
        </footer>
    </div>

    <!-- Premium Upgrade Overlay -->
    <div id="premium-overlay" class="premium-overlay hidden">
        <div class="premium-container">
            <h2>Premium Evidence Access</h2>
            <p>Upgrade your clearance level to view classified evidence files and gain deeper insights into the investigation.</p>
            
            <div class="premium-tiers">
                <div class="premium-tier">
                    <h3>Investigator Toolkit</h3>
                    <p>Access to basic classified evidence and case files.</p>
                    <button class="premium-button" data-tier="investigator-toolkit">Upgrade</button>
                </div>
                
                <div class="premium-tier">
                    <h3>Insider Access</h3>
                    <p>Advanced evidence files and behind-the-scenes insights.</p>
                    <button class="premium-button" data-tier="insider-access">Upgrade</button>
                </div>
                
                <div class="premium-tier">
                    <h3>Architect's Confidential</h3>
                    <p>Complete access to all evidence, including personal notes.</p>
                    <button class="premium-button" data-tier="architects-confidential">Upgrade</button>
                </div>
            </div>
            
            <button id="close-premium-overlay" class="close-button">Close</button>
        </div>
    </div>

    <script>
        // Wait for DOM content to be loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if API Proxy is available
            if (typeof ApiProxy === 'undefined') {
                console.error('API Proxy not available. Cannot proceed with authentication.');
                showError('API services are not available. Please try accessing this page through the main game experience.');
                return;
            }

            // Initialize API proxy
            const apiProxy = new ApiProxy();
            
            // Initialize the page
            initPage();
            
            // Main initialization function
            async function initPage() {
                try {
                    // Show loading state
                    showLoading(true);
                    
                    // Check authentication
                    const authData = getPlayerAuth();
                    
                    if (!authData || !authData.token) {
                        // No authentication token found, try to generate one
                        await generateAuthToken();
                    } else {
                        // Validate the existing token
                        const isValid = await validateToken(authData.token);
                        if (!isValid) {
                            // Token is invalid, generate a new one
                            await generateAuthToken();
                        }
                    }
                    
                    // Load evidence content
                    await loadEvidenceContent();
                    
                    // Set up event listeners
                    setupEventListeners();
                    
                    // Hide loading state
                    showLoading(false);
                } catch (error) {
                    console.error('Initialization error:', error);
                    showError('Failed to initialize the evidence archive. Please refresh the page or contact support.');
                    showLoading(false);
                }
            }
            
            // Set up event listeners for interactive elements
            function setupEventListeners() {
                // Handle premium upgrade buttons
                document.querySelectorAll('.premium-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const tier = this.getAttribute('data-tier');
                        upgradeToPremium(tier);
                        hidePremiumOverlay();
                    });
                });
                
                // Close premium overlay when close button is clicked
                const closeButton = document.getElementById('close-premium-overlay');
                if (closeButton) {
                    closeButton.addEventListener('click', function() {
                        hidePremiumOverlay();
                    });
                }
                
                // Add retry button functionality
                const retryButton = document.getElementById('retry-button');
                if (retryButton) {
                    retryButton.addEventListener('click', function() {
                        window.location.reload();
                    });
                }
            }

            const evidenceGrid = document.getElementById('evidence-grid');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorContainer = document.getElementById('error-container');
            const premiumOverlay = document.getElementById('premium-overlay');
            
            // Get player auth from URL parameters or localStorage
            function getPlayerAuth() {
                // First try to get from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const playerParam = urlParams.get('player');
                const tokenParam = urlParams.get('token');
                
                // If token is in URL, store it in localStorage
                if (tokenParam) {
                    localStorage.setItem('auth_token', tokenParam);
                    // Store player email if provided
                    if (playerParam) {
                        localStorage.setItem('player_email', playerParam);
                        localStorage.setItem('player_last_access', Date.now().toString());
                    }
                }
                
                // Get token from localStorage
                const authToken = localStorage.getItem('auth_token');
                
                // Get player email from URL or localStorage
                let playerEmail = playerParam;
                if (!playerEmail) {
                    playerEmail = localStorage.getItem('player_email');
                    // Validate stored email is not too old (24 hours)
                    const lastAccess = parseInt(localStorage.getItem('player_last_access') || '0');
                    const MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours
                    if (Date.now() - lastAccess > MAX_AGE) {
                        // Clear expired data
                        localStorage.removeItem('player_email');
                        playerEmail = null;
                    }
                }
                
                return {
                    email: playerEmail,
                    token: authToken
                };
            }
            
            // Generate a new auth token
            async function generateAuthToken() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const playerEmail = urlParams.get('player');
                    
                    if (!playerEmail) {
                        throw new Error('No player email provided');
                    }
                    
                    const response = await apiProxy.fetch('/api/external/generate-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            playerEmail: playerEmail,
                        }),
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to generate token');
                    }
                    
                    const data = await response.json();
                    
                    if (data.token) {
                        // Save the token to localStorage
                        localStorage.setItem('playerAuth', JSON.stringify({
                            email: playerEmail,
                            token: data.token
                        }));
                        return true;
                    } else {
                        throw new Error('No token returned from API');
                    }
                } catch (error) {
                    console.error('Error generating auth token:', error);
                    return false;
                }
            }
            
            // Validate a JWT token
            async function validateToken(token) {
                try {
                    const response = await apiProxy.fetchWithAuth('/api/external/validate-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (!response.ok) {
                        return false;
                    }
                    
                    const data = await response.json();
                    return data.valid === true;
                } catch (error) {
                    console.error('Error validating token:', error);
                    return false;
                }
            }
            
            // Load evidence content immediately
            async function loadEvidenceContent() {
                showLoading(true);
                hideError();
                
                try {
                    const { email, token } = getPlayerAuth();
                    
                    if (!email) {
                        showError('Authentication required. Please access this page through the main game experience.');
                        hideLoading();
                        return;
                    }
                    
                    // Track evidence access
                    await trackEvidenceAccess(email);
                    
                    // Fetch standard evidence content
                    const standardEvidence = await fetchEvidenceContent(email);
                    
                    // Fetch premium evidence content if user has a token
                    let premiumEvidence = { evidence_items: [] };
                    if (token) {
                        premiumEvidence = await fetchPremiumEvidence(email);
                    }
                    
                    // Get player premium tier
                    const playerPremiumTier = standardEvidence.playerTier || 'free';
                    
                    // Render evidence content
                    renderEvidenceContent(standardEvidence, premiumEvidence, playerPremiumTier);
                    
                    hideLoading();
                } catch (error) {
                    console.error('Error loading evidence content:', error);
                    showError('Failed to load evidence content. Please try again later.');
                    hideLoading();
                }
            }
            
            // Fetch standard evidence content from the API
            async function fetchEvidenceContent(playerEmail) {
                const response = await apiProxy.fetchWithAuth('/api/external/get-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        playerEmail: playerEmail,
                        contentType: 'evidence'
                    })
                }, playerEmail);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch evidence content: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            }
            
            // Fetch premium evidence content from the API
            async function fetchPremiumEvidence(playerEmail) {
                try {
                    const response = await apiProxy.fetchWithAuth('/api/external/premium-content', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            player: playerEmail,
                            contentType: 'evidence'
                        })
                    }, playerEmail);
                    
                    if (!response.ok) {
                        console.warn(`Premium content not available: ${response.status}`);
                        return { evidence_items: [] };
                    }
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching premium evidence:', error);
                    return { evidence_items: [] };
                }
            }
            
            // Render evidence content in the grid
            function renderEvidenceContent(standardData, premiumData, playerTier) {
                // Clear the grid
                evidenceGrid.innerHTML = '';
                
                // Create standard evidence section
                const standardSection = document.createElement('div');
                standardSection.classList.add('evidence-section');
                standardSection.innerHTML = `<h2 class="section-title">Standard Evidence</h2>`;
                
                // Add standard evidence items
                if (standardData.content && standardData.content.length > 0) {
                    standardData.content.forEach(item => {
                        const evidenceCard = createEvidenceCard(item, false);
                        standardSection.appendChild(evidenceCard);
                    });
                } else {
                    standardSection.innerHTML += `<p class="no-evidence-message">No standard evidence files available.</p>`;
                }
                
                evidenceGrid.appendChild(standardSection);
                
                // Create premium evidence sections by tier
                const premiumTiers = {
                    'investigator-toolkit': {
                        title: 'Investigator Toolkit Evidence',
                        items: []
                    },
                    'insider-access': {
                        title: 'Insider Access Evidence',
                        items: []
                    },
                    'architects-confidential': {
                        title: 'Confidential Evidence',
                        items: []
                    }
                };
                
                // Sort premium evidence into tiers
                if (premiumData.evidence_items && premiumData.evidence_items.length > 0) {
                    premiumData.evidence_items.forEach(item => {
                        const tier = item.premium_tier || 'investigator-toolkit';
                        if (premiumTiers[tier]) {
                            premiumTiers[tier].items.push(item);
                        }
                    });
                }
                
                // Create sections for each tier
                Object.keys(premiumTiers).forEach(tier => {
                    const tierData = premiumTiers[tier];
                    if (tierData.items.length > 0) {
                        const tierSection = document.createElement('div');
                        tierSection.classList.add('evidence-section', 'premium-section');
                        tierSection.innerHTML = `<h2 class="section-title">${tierData.title}</h2>`;
                        
                        // Check if player has access to this tier
                        const hasAccess = hasAccessToTier(playerTier, tier);
                        
                        // Add premium evidence items
                        tierData.items.forEach(item => {
                            const evidenceCard = createEvidenceCard(item, !hasAccess);
                            tierSection.appendChild(evidenceCard);
                        });
                        
                        evidenceGrid.appendChild(tierSection);
                    }
                });
                
                // If no evidence found at all
                if (evidenceGrid.children.length === 0) {
                    evidenceGrid.innerHTML = `
                        <div class="error-message">
                            <p>No evidence files available at this time. Check back later as your investigation progresses.</p>
                        </div>
                    `;
                }
            }
            
            // Create an evidence card element
            function createEvidenceCard(item, isPremiumLocked) {
                const card = document.createElement('div');
                card.classList.add('evidence-card');
                
                if (isPremiumLocked) {
                    card.classList.add('premium-locked');
                }
                
                if (item.premium_tier) {
                    card.classList.add('premium-evidence-card');
                    card.setAttribute('data-tier', item.premium_tier);
                }
                
                // Create card content
                card.innerHTML = `
                    <h3 class="evidence-title">${item.title || 'Untitled Evidence'}</h3>
                    <div class="evidence-meta">
                        <span class="evidence-date">${item.date || 'Unknown Date'}</span>
                        <span class="evidence-type">${item.type || 'Document'}</span>
                    </div>
                    <div class="evidence-content">${item.content || 'No content available.'}</div>
                `;
                
                // Add tags if available
                if (item.tags && item.tags.length > 0) {
                    const tagsContainer = document.createElement('div');
                    tagsContainer.classList.add('evidence-tags');
                    
                    item.tags.forEach(tag => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('evidence-tag');
                        tagElement.textContent = tag;
                        tagsContainer.appendChild(tagElement);
                    });
                    
                    card.appendChild(tagsContainer);
                }
                
                // Add premium overlay for locked content
                if (isPremiumLocked) {
                    const overlay = document.createElement('div');
                    overlay.classList.add('premium-overlay');
                    overlay.innerHTML = `
                        <div class="premium-lock-icon">🔒</div>
                        <div class="premium-message">Premium Content</div>
                        <button class="premium-access-button" data-tier="${item.premium_tier}">Upgrade Access</button>
                    `;
                    
                    // Add click event to upgrade button
                    overlay.querySelector('.premium-access-button').addEventListener('click', function() {
                        showPremiumOverlay();
                    });
                    
                    card.appendChild(overlay);
                }
                
                return card;
            }
            
            // Check if player has access to a specific tier
            function hasAccessToTier(playerTier, requiredTier) {
                const tierHierarchy = {
                    'free': 0,
                    'none': 0,
                    'investigator-toolkit': 1,
                    'insider-access': 2,
                    'architects-confidential': 3
                };
                
                const playerTierLevel = tierHierarchy[playerTier] || 0;
                const requiredTierLevel = tierHierarchy[requiredTier] || 0;
                
                return playerTierLevel >= requiredTierLevel;
            }
            
            // Format tier name for display
            function formatTierName(tierName) {
                return tierName
                    .split('-')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }
            
            // Track evidence access
            async function trackEvidenceAccess(playerEmail) {
                try {
                    const response = await apiProxy.fetchWithAuth('/api/external/evidence-access', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            playerEmail: playerEmail,
                            fileId: 'evidence-archive-access'
                        })
                    }, playerEmail);
                    
                    return response.ok;
                } catch (error) {
                    console.error('Error tracking evidence access:', error);
                    return false;
                }
            }
            
            // Upgrade to premium tier
            function upgradeToPremium(tier) {
                // In a real implementation, this would redirect to a payment page
                // For now, we'll just log the upgrade request
                console.log(`Upgrade requested to tier: ${tier}`);
                
                // Redirect to the premium upgrade page
                const { email } = getPlayerAuth();
                window.location.href = `../decoding-death-website/premium-upgrade?tier=${tier}&player=${encodeURIComponent(email)}&source=evidence-archive`;
            }
            
            // Show/hide functions
            function showLoading(isLoading) {
                if (isLoading) {
                    loadingIndicator.classList.remove('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                }
            }
            
            function showError(message) {
                errorContainer.classList.remove('hidden');
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <p>${message}</p>
                        <button id="retry-button">Retry</button>
                    </div>
                `;
                
                document.getElementById('retry-button').addEventListener('click', function() {
                    loadEvidenceContent();
                });
            }
            
            function hideError() {
                errorContainer.classList.add('hidden');
            }
            
            function showPremiumOverlay() {
                premiumOverlay.classList.remove('hidden');
            }
            
            function hidePremiumOverlay() {
                premiumOverlay.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
